# ===================
# WITNESS NGINX CONFIGURATION TEMPLATE
# ===================
#
# Replace these placeholders before deploying:
#   {{SERVER_NAME}}    - Your domain (e.g., witness1.example.org)
#   {{ADMIN_IP}}       - Admin IP address
#   {{INTERNAL_CIDR}}  - Internal network CIDR (e.g., 10.0.0.0/8)
#   {{CLIENT_IP}}      - Trusted client IP
#   {{PEER_GATEWAY_1}} - First peer gateway IP
#   {{PEER_GATEWAY_2}} - Second peer gateway IP
#
# ===================

# ===================
# UPSTREAM DEFINITIONS
# ===================

upstream gateway_backend {
    server 127.0.0.1:8080;
}

upstream witness_a1 {
    server 127.0.0.1:3001;
}

upstream witness_b3 {
    server 127.0.0.1:3002;
}

upstream witness_c2 {
    server 127.0.0.1:3003;
}

# ===================
# SERVER CONFIGURATION
# ===================

server {
    listen 80;
    server_name {{SERVER_NAME}};
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name {{SERVER_NAME}};

    ssl_certificate /etc/letsencrypt/live/{{SERVER_NAME}}/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/{{SERVER_NAME}}/privkey.pem;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256;
    ssl_prefer_server_ciphers off;

    # ===================
    # GATEWAY ENDPOINTS
    # ===================

    # Health check - public
    location = /health {
        proxy_pass http://gateway_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # Metrics endpoint - restricted to admin
    location = /metrics {
        allow {{ADMIN_IP}};
        deny all;

        proxy_pass http://gateway_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # Admin panel - restricted
    location /admin {
        allow {{ADMIN_IP}};
        allow {{INTERNAL_CIDR}};
        deny all;

        proxy_pass http://gateway_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # ===================
    # GATEWAY V1 API
    # ===================

    # Config endpoint - public (for client discovery)
    location = /v1/config {
        proxy_pass http://gateway_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # Timestamp create - restricted to trusted clients
    location = /v1/timestamp {
        allow {{ADMIN_IP}};
        allow {{CLIENT_IP}};
        deny all;

        proxy_pass http://gateway_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Timestamp retrieval by hash - public (read-only)
    location ~ ^/v1/timestamp/[a-fA-F0-9]+$ {
        proxy_pass http://gateway_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # Verify endpoint - public (verification is read-only)
    location = /v1/verify {
        proxy_pass http://gateway_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # Federation anchor endpoint - restricted to gateway peers
    location = /v1/federation/anchor {
        allow 127.0.0.1;
        allow {{PEER_GATEWAY_1}};
        allow {{PEER_GATEWAY_2}};
        deny all;

        proxy_pass http://gateway_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # External anchors by hash - public (read-only)
    location ~ ^/v1/anchors/[a-fA-F0-9]+$ {
        proxy_pass http://gateway_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # Light client proof endpoint - public (read-only)
    location ~ ^/v1/proof/[a-fA-F0-9]+$ {
        proxy_pass http://gateway_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # WebSocket events - restricted to trusted clients
    location = /ws/events {
        allow {{ADMIN_IP}};
        allow {{CLIENT_IP}};
        deny all;

        proxy_pass http://gateway_backend;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_read_timeout 86400;
    }

    # Catch-all for /v1/ - restricted to trusted clients
    location /v1/ {
        allow {{ADMIN_IP}};
        allow {{CLIENT_IP}};
        deny all;

        proxy_pass http://gateway_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # ===================
    # WITNESS ENDPOINTS
    # ===================

    # Health checks - public
    location = /witness-a1/health { proxy_pass http://witness_a1/health; }
    location = /witness-b3/health { proxy_pass http://witness_b3/health; }
    location = /witness-c2/health { proxy_pass http://witness_c2/health; }

    # Info endpoints - public (for key discovery)
    location = /witness-a1/v1/info { proxy_pass http://witness_a1/v1/info; }
    location = /witness-b3/v1/info { proxy_pass http://witness_b3/v1/info; }
    location = /witness-c2/v1/info { proxy_pass http://witness_c2/v1/info; }

    # Sign endpoints - ONLY from gateway peers
    location = /witness-a1/v1/sign {
        allow 127.0.0.1;
        allow {{PEER_GATEWAY_1}};
        allow {{PEER_GATEWAY_2}};
        deny all;

        proxy_pass http://witness_a1/v1/sign;
    }

    location = /witness-b3/v1/sign {
        allow 127.0.0.1;
        allow {{PEER_GATEWAY_1}};
        allow {{PEER_GATEWAY_2}};
        deny all;

        proxy_pass http://witness_b3/v1/sign;
    }

    location = /witness-c2/v1/sign {
        allow 127.0.0.1;
        allow {{PEER_GATEWAY_1}};
        allow {{PEER_GATEWAY_2}};
        deny all;

        proxy_pass http://witness_c2/v1/sign;
    }

    # ===================
    # DEFAULT
    # ===================

    # Catch-all (restricted to admin)
    location / {
        allow {{ADMIN_IP}};
        deny all;

        proxy_pass http://gateway_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
